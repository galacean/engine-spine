# 不要修改该文件，会自动生成，详见 https://gitlab.alibaba-inc.com/node/ci
{%- if variables.length %}
variables:
  {%- for item in variables %}
  {{item.name}}: "{{item.value}}"
  {%- endfor %}
{%- endif %}
before_script:
  - export PATH=$PWD/node_modules/.bin:$PATH
  - echo $PATH
  - time enclose install tnpm:tnpm
  - tnpm -v
{%- if mosn %}
  - dbmode=dev confregurl=confreg.sit.alipay.net zone=GZ00B domainname=stable.alipay.net env > /home/admin/server.conf
  - nohup /home/admin/mosn/bin/mosnd start --config /home/admin/mosn/conf/mosn_config.json &
{%- endif %}
{%- if obproxy %}
  - /opt/taobao/install/obproxy/bin/obproxyd.sh -c start -e offline -n chair_test
{%- endif %}

{%- for item in versions %}
{{item.name}}-{{item.version}}:
  image: {{image}}
  script:
    - time tnpm i --install-{{item.name}}={{item.version}} --no-cache --internal-oss-cache
    - node -e "console.log('%j, %j', process.versions, process.execPath)"
    - time tnpm run {{command}}
  tags:
    - swarm
{%- else %}
test:
  image: {{image}}
  script:
    - time tnpm i --no-cache --internal-oss-cache
    - node -e "console.log('%j, %j', process.versions, process.execPath)"
    - time tnpm run {{command}}
  tags:
    - swarm
{%- endfor %}

{%- if fntest %}
macaca:
  image: reg.docker.alibaba-inc.com/macaca/macaca-electron:2.0.4
  script:
    - time tnpm i --no-cache --internal-oss-cache
    - node -e "console.log('%j, %j', process.versions, process.execPath)"
    - time tnpm run macaca
  tags:
    - swarm
{%- endif %}
{%- if services.length %}
services:
  {%- for item in services %}
  - {{ item }}
  {%- endfor %}
{%- endif %}
